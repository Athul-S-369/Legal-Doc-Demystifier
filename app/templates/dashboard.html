<!doctype html>
<html>

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Document Dashboard</title>
    <link rel="stylesheet" href="/static/css/style.css" />
</head>

<body>
    <div class="container">
        <h1>Document Dashboard</h1>
        <div class="team-branding">
            <p style="text-align: center; color: #666; font-size: 14px; margin-bottom: 20px;">
                ðŸš€ Made by <strong>Team Atomic</strong> | Lead Developer: <strong>Athul S</strong>
            </p>
        </div>
        <div class="grid">
            <section class="card">
                <h2>Summary</h2>
                <pre class="preview" style="white-space: pre-wrap; font-family: inherit;">{{ summary }}</pre>
                <div class="actions">
                    <a href="/export/summary/{{ doc_id }}" class="btn">Download Summary</a>
                    <a href="/export/clauses/{{ doc_id }}" class="btn">Download Clauses</a>
                </div>
            </section>
            <section class="card">
                <h2>High-Risk Clauses</h2>
                <ul>
                    {% for r in risks %}
                    <li>
                        <strong>{{ r.risk_percent }}%:</strong> {{ ', '.join(r.labels) }}
                        <div class="preview">{{ r.preview }}</div>
                    </li>
                    {% else %}
                    <li>No specific risks detected by heuristics.</li>
                    {% endfor %}
                </ul>
            </section>
            <section class="card chat">
                <h2>Ask about this document</h2>
                <div class="ai-features" style="margin-bottom: 10px;">
                    <button id="get-insights-btn" class="btn" style="background: #4CAF50; margin-right: 5px;">Get AI Insights</button>
                    <button id="suggest-questions-btn" class="btn" style="background: #2196F3;">Suggest Questions</button>
                </div>
                <div id="chatbox"></div>
                <div class="chat-input">
                    <input type="text" id="chat-query" placeholder="Type your question" />
                    <button id="send-btn">Send</button>
                    <form action="/delete/{{ doc_id }}" method="post" style="margin-left:8px; display:inline;">
                        <button class="btn" style="background:#e05b5b"
                            onclick="return confirm('Delete this document and all data?')">Delete Document</button>
                    </form>
                </div>
            </section>
        </div>
    </div>
    <script>
        const docId = "{{ doc_id }}";
        const chatbox = document.getElementById('chatbox');
        const input = document.getElementById('chat-query');
        document.getElementById('send-btn').onclick = async () => {
            const q = input.value.trim();
            if (!q) return;
            appendMsg('You', q);
            input.value = '';
            const res = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ query: q, doc_id: docId })
            });
            const data = await res.json();
            appendMsg('Assistant', data.answer);
            if (data.citations && data.citations.length) {
                appendMsg('Citations', data.citations.map(c => '- ' + c).join('\n'));
            }
        };

        function appendMsg(who, text) {
            const div = document.createElement('div');
            div.className = 'msg';
            div.innerText = who + ': ' + text;
            chatbox.appendChild(div);
            chatbox.scrollTop = chatbox.scrollHeight;
        }

        // AI Insights functionality
        document.getElementById('get-insights-btn').onclick = async () => {
            const btn = document.getElementById('get-insights-btn');
            btn.textContent = 'Loading...';
            btn.disabled = true;
            
            try {
                const res = await fetch(`/insights/${docId}`);
                const data = await res.json();
                appendMsg('AI Assistant', data.insights);
            } catch (error) {
                appendMsg('Error', 'Failed to get AI insights: ' + error.message);
            } finally {
                btn.textContent = 'Get AI Insights';
                btn.disabled = false;
            }
        };

        // Suggested Questions functionality
        document.getElementById('suggest-questions-btn').onclick = async () => {
            const btn = document.getElementById('suggest-questions-btn');
            btn.textContent = 'Loading...';
            btn.disabled = true;
            
            try {
                const res = await fetch(`/questions/${docId}`);
                const data = await res.json();
                const questions = data.questions.map(q => 'â€¢ ' + q).join('\n');
                appendMsg('AI Assistant', 'Here are some questions you might want to ask:\n\n' + questions);
            } catch (error) {
                appendMsg('Error', 'Failed to get suggested questions: ' + error.message);
            } finally {
                btn.textContent = 'Suggest Questions';
                btn.disabled = false;
            }
        };
    </script>
</body>

</html>